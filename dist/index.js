#!/usr/bin/env node

"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var o=require("fs"),s=require("yargs"),r=e(require("@aws-amplify/core")),i=e(require("aws-sdk"));require("@aws-amplify/Auth"),require("@aws-amplify/PubSub");var t=require("@aws-amplify/pubsub/lib/Providers"),n=require("shortid"),a=require("node-fetch"),u=require("ws"),c=require("os"),l=require("path");global.fetch=a,global.navigator={},global.WebSocket=u;const p=e=>{const o=`${e}-${n.generate()}`,s=new t.AWSIoTProvider({clientId:o});r.addPluggable(s)},d=async(e,o,s)=>{await r.Auth.signIn(e,o);const[t,n]=await Promise.all([r.Auth.currentUserInfo(),r.Auth.currentUserCredentials()]);i.config=new i.Config({credentials:n,region:s});const a={username:t.username,identityId:n.identityId,identityPoolId:n.params.IdentityPoolId};return console.log("authResult - group admins need to accept users with this info",a),a},g=async({username:e,password:o,room:s,msg:i},t)=>{r.configure(t);const n=await d(e,o,t.aws_cognito_region).catch(e=>{console.error("Authentication Failure!"),console.error(e)});if(n)return p(n.identityId),await(async(e,o,s,i)=>{try{return await r.PubSub.publish(`${e}/${s}/${o}`,{msg:i})}catch(e){return e}})(n.identityPoolId,n.identityId,s,i)},m=async({username:e,password:o},s)=>{r.configure(s);const i=await d(e,o,s.aws_cognito_region).catch(e=>{console.error("Authentication Failure!"),console.error(e)});if(i){p(i.identityId);try{r.PubSub.subscribe(`${i.identityPoolId}/#`).subscribe({next:e=>console.log("Message received",e.value),error:e=>console.error("subscribe error",e),close:()=>console.log("Done")})}catch(e){return e}}};global.fetch=a;const y=l.join(c.homedir(),".cognitorc"),w=e=>b()[e],b=()=>{let e;return e=o.existsSync(y)?JSON.parse(o.readFileSync(y,"utf8")):{},e},f=e=>{r.configure(e)},_=async(e,o,s)=>{console.log("username",e),console.log("password",o);await r.Auth.signUp({username:e,password:o,attributes:{email:s}})};s.scriptName("aws-iot").usage("$0 <cmd> [args]").command("signup","",e=>{e.option("key",{type:"string",alias:"k",default:"default",describe:"the key of the config"}).option("usr",{type:"string",alias:"u",describe:"Cognito Userpool Username"}).option("pwd",{type:"string",alias:"p",describe:"Cognito Userpool User Password"}).option("email",{type:"string",alias:"e",describe:"Cognito Userpool User Email"})},e=>{const o=w(e.key);(async({username:e,password:o,email:s},r)=>{f(r);await _(e,o,s).catch(e=>{console.error("SignUp Failure!"),console.error(e)})})({username:e.usr,password:e.pwd,email:e.email},o)}).example("$0 signup --usr user --pwd pass --email abc@example.com --key default","").command("confirm","",e=>{e.option("key",{type:"string",alias:"k",default:"default",describe:"the key of the config"}).option("usr",{type:"string",alias:"u",describe:"Cognito Userpool Username"}).option("code",{type:"string",alias:"c",describe:"Cognito Userpool User Confirmation Code"})},e=>{const o=w(e.key);(async({username:e,code:o},s)=>{f(s),r.Auth.confirmSignUp(e,o,{forceAliasCreation:!0}).then(e=>console.log(e)).catch(e=>console.log(e))})({username:e.usr,code:e.code},o)}).example("$0 confirm --usr user --code 123456 --key default","").command("sub","",e=>{e.option("key",{type:"string",alias:"k",default:"default",describe:"the key of the config"}).option("usr",{type:"string",alias:"u",describe:"Cognito Userpool Username"}).option("pwd",{type:"string",alias:"p",describe:"Cognito Userpool User Password"})},e=>{const o=w(e.key);e.usr&&e.pwd?m({username:e.usr,password:e.pwd},o):m({username:o.usr,password:o.pwd},o)}).example("$0 sub -u user -p pass -k default","").example("$0 sub -k default","").command("pub","",e=>{e.option("key",{type:"string",alias:"k",default:"default",describe:"the key of the config"}).option("usr",{type:"string",alias:"u",describe:"Cognito Userpool Username"}).option("pwd",{type:"string",alias:"p",describe:"Cognito Userpool User Password"}).option("room",{type:"string",alias:"r",describe:"Room to publish to"}).option("msg",{type:"string",alias:"m",describe:"Message to publish"})},e=>{const o=w(e.key);e.usr&&e.pwd?g({username:e.usr,password:e.pwd,room:e.room,msg:e.msg},o).then(e=>{console.log("pub:",e),process.exit()}):g({username:o.usr,password:o.pwd,room:e.room,msg:e.msg},o).then(e=>{console.log("pub:",e),process.exit()})}).example("$0 pub -u user -p pass -r myroom -m msg -k default","").example("$0 pub -r myroom -m msg -k default","").command("config","",e=>{e.option("set",{type:"string",alias:"s",describe:"the config json"}).option("key",{type:"string",alias:"k",default:"default",describe:"the key of the config"}).option("usr",{type:"string",alias:"u",describe:"Cognito Userpool Username"}).option("pwd",{type:"string",alias:"p",describe:"Cognito Userpool User Password"})},e=>{(e=>{const s={usr:e.usr,pwd:e.pwd,aws_user_pools_web_client_id:e.aws_user_pools_web_client_id,aws_user_pools_id:e.aws_user_pools_id,aws_cognito_region:e.aws_cognito_region,aws_cognito_identity_pool_id:e.aws_cognito_identity_pool_id,aws_pubsub_endpoint:e.aws_pubsub_endpoint,aws_pubsub_region:e.aws_pubsub_region,aws_project_region:e.aws_project_region};let r=b();r[e.key]=s;const i=JSON.stringify(r);o.writeFileSync(y,i)})(e)}).example("$0 config --set aws-exports.json","").example("$0 config --set aws-exports.json --key default --usr user --pwd pass","").config("set","configuration",(function(e){return JSON.parse(o.readFileSync(e,"utf-8"))})).version().help().argv;
